name: Fetch and release clang tools

on:
  workflow_dispatch:
    inputs:
      version:
        description: "LLVM release version (e.g. 21.1.5)"
        required: true

permissions:
  contents: write

jobs:
  release-binaries:
    runs-on: ubuntu-latest

    steps:
      - name: Prepare
        run: sudo apt-get update && sudo apt-get install -y wget xz-utils tar

      - name: Download LLVM release
        run: |
          VER=${{ github.event.inputs.version }}
          wget -q -O llvm.tar.xz \
            https://github.com/llvm/llvm-project/releases/download/llvmorg-${VER}/LLVM-${VER}-Linux-X64.tar.xz
          echo "✅ Downloaded LLVM $VER"

      - name: Extract LLVM
        run: |
          # Extract all contents into a known folder
          mkdir -p llvm-extract
          tar -xf llvm.tar.xz -C llvm-extract --strip-components=1
          echo "✅ Extracted LLVM archive into llvm-extract/"

      - name: Package minimal LLVM
        run: |
          mkdir -p artifacts
          BIN_DIR="llvm-extract/bin"
          MINIMAL_DIR="llvm-minimal"

          # Create a temporary folder for minimal binaries
          mkdir -p "$MINIMAL_DIR"

          # List of tools to include
          TOOLS=(
            clang-21
            clang-format
            clang-tidy
            run-clang-tidy
          )

          for TOOL in "${TOOLS[@]}"; do
            if [ -f "$BIN_DIR/$TOOL" ]; then
              cp "$BIN_DIR/$TOOL" "$MINIMAL_DIR/"
              echo "Added $TOOL"
            else
              echo "$TOOL not found"
              exit 1
            fi
          done

          # Recreate symlinks inside the folder
          ln -s clang-21 "$MINIMAL_DIR/clang"
          ln -s clang-21 "$MINIMAL_DIR/clang++"

          # Create a single tar.gz
          tar -czvf artifacts/clang-${{ github.event.inputs.version }}-minimal-linux-x64.tar.gz -C "$MINIMAL_DIR" .

          ls -lh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.event.inputs.version }}"
          name: "Clang ${{ github.event.inputs.version }} Minimal"
          body: |
            LLVM binaries for version ${{ github.event.inputs.version }}:
            - clang-21
            - clang-format
            - clang-tidy
            - run-clang-tidy
          files: artifacts/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
