name: Fetch and release clang tools

on:
  workflow_dispatch:
    inputs:
      version:
        description: "LLVM release version (e.g. 21.1.5)"
        required: true

permissions:
  contents: write

jobs:
  release-binaries:
    runs-on: ubuntu-latest

    steps:
      - name: Prepare
        run: sudo apt-get update && sudo apt-get install -y wget xz-utils tar

      - name: Download LLVM release
        run: |
          VER=${{ github.event.inputs.version }}
          wget -q -O llvm.tar.xz \
            https://github.com/llvm/llvm-project/releases/download/llvmorg-${VER}/LLVM-${VER}-Linux-X64.tar.xz
          echo "✅ Downloaded LLVM $VER"

      - name: Extract LLVM
        run: |
          # Extract all contents into a known folder
          mkdir -p llvm-extract
          tar -xf llvm.tar.xz -C llvm-extract --strip-components=1
          echo "✅ Extracted LLVM archive into llvm-extract/"

      - name: Package binaries
        run: |
          mkdir -p artifacts
          BIN_DIR="llvm-extract/bin"

          TOOLS=(
            clang-format
            clang-tidy
            clang-query
            clang-apply-replacements
            run-clang-tidy
          )

          for TOOL in "${TOOLS[@]}"; do
            if [ -f "$BIN_DIR/$TOOL" ]; then
              tar -czf artifacts/${TOOL}-${{ github.event.inputs.version }}-linux-x64.tar.gz -C "$BIN_DIR" "$TOOL"
              echo "Packaged $TOOL"
            else
              echo "$TOOL not found"
            fi
          done

      - name: List artifacts
        run: ls -lh artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.event.inputs.version }}"
          name: "Clang Tools ${{ github.event.inputs.version }}"
          body: |
            LLVM tools for version ${{ github.event.inputs.version }}:
            - clang-format
            - clang-tidy
            - clang-query
            - clang-apply-replacements
          files: artifacts/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
